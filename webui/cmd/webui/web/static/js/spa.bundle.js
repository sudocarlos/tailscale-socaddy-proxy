(()=>{(()=>{let s={relays:[],proxies:[],showRelays:!0,showProxies:!0,tailnetFQDN:"",logs:[],logLevel:"INFO",logStream:null,currentEditItem:null,currentEditType:null,deleteTarget:null},o={items:document.getElementById("items"),lastUpdated:document.getElementById("last-updated"),itemCount:document.getElementById("item-count"),alertContainer:document.getElementById("alert-container"),logOutput:document.getElementById("log-output"),logLevel:document.getElementById("log-level"),logLevelSelect:document.getElementById("log-level-select"),refresh:document.getElementById("refresh"),clearLogs:document.getElementById("clear-logs"),filterRelay:document.getElementById("filter-relay"),filterProxy:document.getElementById("filter-proxy"),themeToggle:document.getElementById("theme-toggle"),addRelayBtn:document.getElementById("add-relay-btn"),addProxyBtn:document.getElementById("add-proxy-btn"),saveRelayBtn:document.getElementById("save-relay-btn"),saveProxyBtn:document.getElementById("save-proxy-btn"),confirmDeleteBtn:document.getElementById("confirm-delete-btn")},v=[],P=()=>{let e=localStorage.getItem("theme");return e||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")},h=e=>{document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e),S(e)},S=e=>{if(!o.themeToggle)return;let a=e==="dark"?"bi-moon-stars-fill":"bi-sun-fill";o.themeToggle.querySelector("use").setAttribute("href",`/static/vendor/bootstrap-icons/bootstrap-icons.svg#${a}`)},R=()=>{let a=(document.documentElement.getAttribute("data-bs-theme")||"light")==="dark"?"light":"dark";h(a)},c=async(e,a={})=>{let t=await fetch(e,{credentials:"same-origin",headers:{"Content-Type":"application/json",...a.headers||{}},...a});if(!t.ok){let n=await t.text();throw new Error(n||`Request failed: ${t.status}`)}return t.json()},C=()=>{let e=new Date;o.lastUpdated.textContent=e.toLocaleTimeString()},i=(e,a)=>{let t=document.createElement("div");t.className=`alert alert-${e} alert-dismissible fade show`,t.setAttribute("role","alert"),t.innerHTML=`
      <div>${a}</div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `,o.alertContainer.appendChild(t),setTimeout(()=>{t.classList.remove("show"),t.addEventListener("transitionend",()=>t.remove())},6e3)},D=e=>`tcp://${s.tailnetFQDN||"unknown"}:${e.listen_port} \u2192 ${e.target_host}:${e.target_port}`,M=e=>{let a=e.port?`:${e.port}`:"",t=`https://${e.hostname}${a}`;return`<a class="proxy-link" href="${t}" target="_blank" rel="noopener">${t}</a>`},p=e=>{o.items.innerHTML=`
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center text-muted">
            ${e}
          </div>
        </div>
      </div>
    `},f=()=>{O();let a=[...s.relays.map(t=>({type:"relay",relay:t.relay,running:t.running})),...s.proxies.map(t=>({type:"proxy",proxy:t}))].filter(t=>t.type==="relay"?s.showRelays:s.showProxies);if(o.itemCount.textContent=`${a.length} item${a.length===1?"":"s"}`,!a.length){!s.showRelays&&!s.showProxies?p("Enable TCP relays or HTTPS proxies to view items."):s.showRelays&&!s.showProxies?p("No TCP relays configured."):!s.showRelays&&s.showProxies?p("No HTTPS proxies configured."):p("No relays or proxies configured.");return}o.items.innerHTML=a.map(t=>{var L,T,k;if(t.type==="relay"){let g=t.relay,y=t.running,W=y?"text-bg-success":"text-bg-secondary",X=(L=g.autostart)!=null?L:!1;return`
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <span class="badge text-bg-info" data-bs-toggle="tooltip" title="served by socat">TCP Relay</span>
                      <span class="fw-semibold">${D(g)}</span>
                    </div>
                    <div class="small text-muted mt-1">ID: ${g.id}</div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge ${W}">${y?"Running":"Stopped"}</span>
                    <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                      <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                             ${X?"checked":""} 
                             data-type="relay" data-id="${g.id}">
                      <label class="form-check-label small text-muted">Autostart</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm action-btn" data-type="relay" data-id="${g.id}" data-running="${y}">
                      <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${y?"bi-pause-fill":"bi-play-fill"}"></use></svg>
                      ${y?"Pause":"Start"}
                    </button>
                    <button class="btn btn-outline-primary btn-sm edit-btn" data-type="relay" data-id="${g.id}">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-btn" data-type="relay" data-id="${g.id}" data-name="tcp://${s.tailnetFQDN}:${g.listen_port}">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `}let n=t.proxy,l=(T=n.running)!=null?T:n.Running,r=l?"text-bg-success":"text-bg-secondary",d=l?"Caddy Running":"Caddy Down",u=(k=n.autostart)!=null?k:!1,b=n.port?`${n.hostname}:${n.port}`:n.hostname;return`
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="badge text-bg-primary" data-bs-toggle="tooltip" title="served by caddy">HTTPS Proxy</span>
                    <span class="fw-semibold">${M(n)} \u2192 ${n.target}</span>
                  </div>
                  <div class="small text-muted mt-1">ID: ${n.id}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge ${r}">${d}</span>
                  <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                    <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                           ${u?"checked":""} 
                           data-type="proxy" data-id="${n.id}">
                    <label class="form-check-label small text-muted">Autostart</label>
                  </div>
                  <button class="btn btn-outline-secondary btn-sm action-btn" data-type="proxy" data-id="${n.id}" data-enabled="${n.enabled}">
                    <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${n.enabled?"bi-pause-fill":"bi-play-fill"}"></use></svg>
                    ${n.enabled?"Pause":"Start"}
                  </button>
                  <button class="btn btn-outline-primary btn-sm edit-btn" data-type="proxy" data-id="${n.id}">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-type="proxy" data-id="${n.id}" data-name="https://${b}">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `}).join(""),N()},N=()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{v.push(new bootstrap.Tooltip(e))})},O=()=>{for(;v.length;)v.pop().dispose()},m=async()=>{try{let[e,a,t]=await Promise.all([c("/api/socat/relays"),c("/api/caddy/proxies"),c("/api/tailscale/status")]);s.relays=e.map(n=>{var l;return{relay:n.Relay||n.relay,running:(l=n.Running)!=null?l:n.running}}),s.proxies=a.map(n=>{var l;return{...n,running:(l=n.running)!=null?l:n.Running}}),s.tailnetFQDN=t.MagicDNSName||t.magicDNSName||"",f(),C()}catch(e){i("danger",e.message)}},A=async(e,a)=>{let t=a?`/api/socat/stop?id=${encodeURIComponent(e)}`:`/api/socat/start?id=${encodeURIComponent(e)}`;await c(t,{method:"POST"})},_=async(e,a)=>{await c("/api/caddy/toggle",{method:"POST",body:JSON.stringify({id:e,enabled:!a})})},F=async(e,a,t)=>{var d;let n=e==="relay"?"/api/socat/update":"/api/caddy/update",l=e==="relay"?(d=s.relays.find(u=>u.relay.id===a))==null?void 0:d.relay:s.proxies.find(u=>u.id===a);if(!l)throw new Error(`${e} not found`);let r={...l,autostart:t};await c(n,{method:"POST",body:JSON.stringify(r)})},H=async e=>{let a=e.target.closest(".action-btn");if(!a)return;a.disabled=!0;let t=a.dataset.type;try{if(t==="relay"){let n=a.dataset.running==="true";await A(a.dataset.id,n)}else{let n=a.dataset.enabled==="true";await _(a.dataset.id,n)}await m()}catch(n){i("danger",n.message)}finally{a.disabled=!1}},q=async e=>{let a=e.target;if(!a.classList.contains("autostart-toggle"))return;let{type:t,id:n}=a.dataset,l=a.checked;a.disabled=!0;try{await F(t,n,l),await m()}catch(r){i("danger",r.message),a.checked=!l}finally{a.disabled=!1}},x=e=>{if(!e||!e.message)return;let t=(e.timestamp?new Date(e.timestamp):new Date).toLocaleTimeString(),n=e.source?` [${e.source}]`:"",l=`${t} [${e.level}]${n} ${e.message}`,r=o.logOutput,d=r.scrollTop+r.clientHeight>=r.scrollHeight-8;r.textContent+=`${l}
`,d&&(r.scrollTop=r.scrollHeight)},J=async()=>{try{let e=await c("/api/logs");s.logs=e.logs||[],s.logLevel=e.level||"INFO",o.logLevel.textContent=s.logLevel,o.logLevelSelect&&(o.logLevelSelect.value=s.logLevel),o.logOutput.textContent="",s.logs.forEach(x)}catch(e){i("warning",e.message)}},U=async e=>{try{let a=await c("/api/logs/level",{method:"POST",body:JSON.stringify({level:e})});s.logLevel=a.level||e,o.logLevel.textContent=s.logLevel,o.logLevelSelect&&(o.logLevelSelect.value=s.logLevel)}catch(a){i("warning",a.message)}},Q=()=>{s.logStream&&s.logStream.close();let e=new EventSource("/api/logs/stream");e.onmessage=a=>{try{let t=JSON.parse(a.data);if(t.connected)return;x(t)}catch{}},e.onerror=()=>{i("warning","Log stream disconnected. Retrying...")},s.logStream=e},E=(e=null)=>{var n;let a=new bootstrap.Modal(document.getElementById("relayModal")),t=document.querySelector("#relayModal .modal-title");s.currentEditItem=e,s.currentEditType="relay",e?(t.textContent="Edit Relay",document.getElementById("relay-id").value=e.id,document.getElementById("relay-listen-port").value=e.listen_port,document.getElementById("relay-target-host").value=e.target_host,document.getElementById("relay-target-port").value=e.target_port,document.getElementById("relay-autostart").checked=(n=e.autostart)!=null?n:!1):(t.textContent="Add Relay",document.getElementById("relayForm").reset(),document.getElementById("relay-id").value="",document.getElementById("relay-autostart").checked=!0),a.show()},B=(e=null)=>{var n,l,r;let a=new bootstrap.Modal(document.getElementById("proxyModal")),t=document.querySelector("#proxyModal .modal-title");s.currentEditItem=e,s.currentEditType="proxy",e?(t.textContent="Edit Proxy",document.getElementById("proxy-id").value=e.id,document.getElementById("proxy-hostname").value=e.hostname,document.getElementById("proxy-port").value=e.port||"",document.getElementById("proxy-target").value=e.target,document.getElementById("proxy-tls").checked=(n=e.tls)!=null?n:!1,document.getElementById("proxy-trusted-proxies").checked=(l=e.trusted_proxies)!=null?l:!1,document.getElementById("proxy-autostart").checked=(r=e.autostart)!=null?r:!1):(t.textContent="Add Proxy",document.getElementById("proxyForm").reset(),document.getElementById("proxy-id").value="",document.getElementById("proxy-autostart").checked=!0),a.show()},I=async()=>{let e=document.getElementById("relay-id").value,a=parseInt(document.getElementById("relay-listen-port").value),t=document.getElementById("relay-target-host").value.trim(),n=parseInt(document.getElementById("relay-target-port").value),l=document.getElementById("relay-autostart").checked;if(!a||!t||!n){i("danger","Please fill in all required fields");return}let r={listen_port:a,target_host:t,target_port:n,autostart:l,enabled:!0};e&&(r.id=e);try{o.saveRelayBtn.disabled=!0,await c(e?"/api/socat/update":"/api/socat/create",{method:"POST",body:JSON.stringify(r)}),bootstrap.Modal.getInstance(document.getElementById("relayModal")).hide(),i("success",`Relay ${e?"updated":"created"} successfully`),await m()}catch(d){i("danger",d.message)}finally{o.saveRelayBtn.disabled=!1}},w=async()=>{let e=document.getElementById("proxy-id").value,a=document.getElementById("proxy-hostname").value.trim(),t=document.getElementById("proxy-port").value.trim(),n=document.getElementById("proxy-target").value.trim(),l=document.getElementById("proxy-tls").checked,r=document.getElementById("proxy-trusted-proxies").checked,d=document.getElementById("proxy-autostart").checked;if(!a||!n){i("danger","Please fill in all required fields");return}let u={hostname:a,target:n,tls:l,trusted_proxies:r,autostart:d,enabled:!0};t&&(u.port=parseInt(t)),e&&(u.id=e);try{o.saveProxyBtn.disabled=!0,await c(e?"/api/caddy/update":"/api/caddy/create",{method:"POST",body:JSON.stringify(u)}),bootstrap.Modal.getInstance(document.getElementById("proxyModal")).hide(),i("success",`Proxy ${e?"updated":"created"} successfully`),await m()}catch(b){i("danger",b.message)}finally{o.saveProxyBtn.disabled=!1}},j=(e,a,t)=>{let n=new bootstrap.Modal(document.getElementById("deleteModal")),l=document.getElementById("delete-message");s.deleteTarget={type:e,id:a},l.textContent=`Are you sure you want to delete ${e==="relay"?"relay":"proxy"} "${t}"? This action cannot be undone.`,n.show()},z=async()=>{if(!s.deleteTarget)return;let{type:e,id:a}=s.deleteTarget;try{o.confirmDeleteBtn.disabled=!0;let t=e==="relay"?`/api/socat/delete?id=${encodeURIComponent(a)}`:`/api/caddy/delete?id=${encodeURIComponent(a)}`;await c(t,{method:"POST"}),bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide(),i("success",`${e==="relay"?"Relay":"Proxy"} deleted successfully`),await m()}catch(t){i("danger",t.message)}finally{o.confirmDeleteBtn.disabled=!1,s.deleteTarget=null}},G=async e=>{var l;let a=e.target.closest(".edit-btn");if(!a)return;let t=a.dataset.type,n=a.dataset.id;if(t==="relay"){let r=(l=s.relays.find(d=>d.relay.id===n))==null?void 0:l.relay;r&&E(r)}else if(t==="proxy"){let r=s.proxies.find(d=>d.id===n);r&&B(r)}},K=async e=>{let a=e.target.closest(".delete-btn");if(!a)return;let t=a.dataset.type,n=a.dataset.id,l=a.dataset.name;j(t,n,l)},V=()=>{var e,a;o.items.addEventListener("click",H),o.items.addEventListener("click",G),o.items.addEventListener("click",K),o.items.addEventListener("change",q),o.filterRelay.addEventListener("change",()=>{s.showRelays=o.filterRelay.checked,f()}),o.filterProxy.addEventListener("change",()=>{s.showProxies=o.filterProxy.checked,f()}),o.themeToggle&&o.themeToggle.addEventListener("click",R),o.refresh.addEventListener("click",m),o.clearLogs.addEventListener("click",()=>{o.logOutput.textContent=""}),o.logLevelSelect&&o.logLevelSelect.addEventListener("change",t=>{U(t.target.value)}),o.addRelayBtn&&o.addRelayBtn.addEventListener("click",t=>{t.preventDefault(),E()}),o.addProxyBtn&&o.addProxyBtn.addEventListener("click",t=>{t.preventDefault(),B()}),o.saveRelayBtn&&o.saveRelayBtn.addEventListener("click",I),o.saveProxyBtn&&o.saveProxyBtn.addEventListener("click",w),o.confirmDeleteBtn&&o.confirmDeleteBtn.addEventListener("click",z),(e=document.getElementById("relayForm"))==null||e.addEventListener("submit",t=>{t.preventDefault(),I()}),(a=document.getElementById("proxyForm"))==null||a.addEventListener("submit",t=>{t.preventDefault(),w()})},$=async()=>{h(P()),V(),await m(),await J(),Q(),setInterval(m,15e3)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$):$()})();})();

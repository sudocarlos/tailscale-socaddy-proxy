# syntax=docker/dockerfile:1
# Development Dockerfile that uses pre-built local webui binary
# Build frontend assets and webui locally first: make frontend-build dev-build
ARG TAILSCALE_VERSION=v1.92.5

FROM tailscale/tailscale:$TAILSCALE_VERSION

LABEL maintainer="carlos@sudocarlos.com"

ENV RELAY_LIST=
ENV TS_HOSTNAME=
ENV TS_EXTRA_FLAGS=
ENV TS_STATE_DIR=/var/lib/tailscale/ 
ENV TS_AUTH_ONCE=true
ENV TS_ENABLE_METRICS=true
ENV TS_ENABLE_HEALTH_CHECK=true

RUN apk update && \
    apk upgrade --no-cache && \
    apk add --no-cache ca-certificates mailcap caddy socat && \
    caddy upgrade

# Copy locally-built Web UI binary from ./data
COPY data/tailrelay-webui /usr/bin/tailrelay-webui

# Copy Web UI configuration
COPY webui.yaml /etc/tailrelay/webui.yaml

COPY start.sh /usr/bin/start.sh
RUN chmod +x /usr/bin/start.sh /usr/bin/tailrelay-webui && \
    mkdir --parents /var/run/tailscale && \
    mkdir --parents /var/lib/tailscale/backups && \
    ln -s /tmp/tailscaled.sock /var/run/tailscale/tailscaled.sock && \
    touch /etc/caddy/Caddyfile

# Expose Web UI port
EXPOSE 8021

CMD  [ "start.sh" ]
